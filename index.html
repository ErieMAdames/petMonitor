<html>
<head>
<title>Video Stream</title>
<script>
    let ws;
    let ws_images;

    function initWebSocket() {
        ws = new WebSocket('ws://' + window.location.hostname + ':8765/ws');
        ws_images = new WebSocket('ws://' + window.location.hostname + ':8744/ws');
        ws_images.binaryType = "arraybuffer";
        ws.onopen = () => console.log("WebSocket connection established");
        ws.onclose = () => console.log("WebSocket connection closed");
        ws_images.onopen = () => console.log("WebSocket for Shadow & Habichuela connection established");
        ws_images.onclose = () => console.log("WebSocket for Shadow & Habichuela connection closed");
        const shadowPoopCapture = document.querySelector('.shadow-poop-capture');
        const shadowPoopDetectedWarning = document.querySelector('.shadow-poop-capture-container .detected');
        const habichuelaPoopCapture = document.querySelector('.habichuela-poop-capture');
        const habichuelaPoopDetectedWarning = document.querySelector('.habichuela-poop-capture-container .detected');
        const waterLevelMessage = document.querySelector('.water-level-message');
        const foodLevelMessage = document.querySelector('.food-level-message');
        ws_images.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.image && data.pet) {
                const byteCharacters = atob(data.image); // Decode Base64 string
                const byteNumbers = new Uint8Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const blob = new Blob([byteNumbers], { type: "image/jpeg" });
                const imageUrl = URL.createObjectURL(blob);
                if (data.pet === "shadow") {
                    shadowPoopCapture.src = imageUrl;
                    if (data.detected) {
                        shadowPoopDetectedWarning.style.visibility = 'visible';
                    } else {
                        shadowPoopDetectedWarning.style.visibility = 'hidden';
                    }
                } else if (data.pet === "habichuela") {
                    habichuelaPoopCapture.src = imageUrl;
                    if (data.detected) {
                        habichuelaPoopDetectedWarning.style.visibility = 'visible';
                    } else {
                        habichuelaPoopDetectedWarning.style.visibility = 'hidden';
                    }
                }
            }
            if (data.water_level) {
                if (data.water_level < 1000) {
                    waterLevelMessage.innerHTML = 'Water levels low. Refill water now';
                    waterLevelMessage.classList.add('refill');
                } else {
                    waterLevelMessage.innerHTML = 'Water levels normal';
                    waterLevelMessage.classList.remove('refill');
                }
            }
            if (data.food_level) {
                if (data.food_level > 20) {
                    foodLevelMessage.innerHTML = 'Food levels low. Refill food now';
                    foodLevelMessage.classList.add('refill');
                } else {
                    foodLevelMessage.innerHTML = 'Food levels normal';
                    foodLevelMessage.classList.remove('refill');
                }
            }
        };
        setInterval(
            function() {
                ws_images.send(JSON.stringify({ pet: "shadow" }));
                ws_images.send(JSON.stringify({ pet: "habichuela" }));
            },
            500
        );
        setInterval(
            function() {
                ws_images.send(JSON.stringify({ water_level: "water_level" }));
            },
            500
        );
        setInterval(
            function() {
                ws_images.send(JSON.stringify({ food_level: "food_level" }));
            },
            500
        );
        document.querySelector('#shadow-slider').oninput = function() {
            ws_images.send(JSON.stringify({ slider: "shadow", value: this.value }));
        }
        document.querySelector('#habichuela-slider').oninput = function() {
            ws_images.send(JSON.stringify({ slider: "habichuela", value: this.value }));
        }
    }
    function handleKey(event) {
        const key = event.key.toLowerCase();
        if (['w', 'a', 's', 'd'].includes(key)) {
            ws.send(JSON.stringify({ key: key, action: event.type }));
        }
    }

    window.onload = () => {
        initWebSocket();
        document.addEventListener('keydown', handleKey);
        document.addEventListener('keyup', handleKey);
    };
</script>
<style>
    html {
        background-color: gainsboro;
    }
    header h1 {
        font-size: 72px;
        margin: 40px auto;
        width: fit-content;
        font-family: "Roboto", sans-serif;
        font-weight: 100;
        font-style: normal;
    }
    body {
        font-family: "Roboto", sans-serif;
        font-weight: 100;
        font-style: normal;
    }
    .main-content {
        display: flex;
        justify-content: space-between;
        width: 80vw;
        margin: 0 auto;
    }
    img {
        border: 1px solid gray;
        border-radius: 16px;
    }
    .main-cam {
        transform: rotate(180deg);
    }
    .poop-capture-container {
        height: fit-content;
        width: fit-content;
        display: flex;
        flex-direction: column;
    }
    .shadow-poop-capture-container,
    .habichuela-poop-capture-container {
        position: relative;
    }
    .shadow-poop-capture-container img,
    .habichuela-poop-capture-container img {
        height: 482px;
        width: 642px;
    }
    .shadow-poop-capture-container .label,
    .habichuela-poop-capture-container .label {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translate(-50%, 50%);
        width: fit-content;
        z-index: 999;
        background: black;
        margin: 0;
        color: white;
        padding: 10px;
        border-radius: 10px;
    }
    .shadow-poop-capture-container .detected,
    .habichuela-poop-capture-container .detected {
        position: absolute;
        width: fit-content;
        bottom: 5%;
        left: 25%;
        z-index: 999;
        background: red;
        margin: 0;
        color: white;
        padding: 10px;
        border-radius: 10px;
        animation: blinker 2s linear infinite;
    }
    @keyframes blinker {
        50% {
            opacity: 0;
        }
    }
    @keyframes backgroundFlash {
        50% {
            background-color: red;
        }
    }
    .slider {
        transform: rotate(-90deg);
        position: absolute;
        top: 50%;
        right: -6%;
    }
    .water-level-message,
    .food-level-message {
        width: fit-content;
        font-size: 32px;
        padding: 10px;
        border-radius: 10px;
    }
    .water-level-message.refill,
    .food-level-message.refill {
        animation: backgroundFlash 2s linear infinite;
    }
    .water-food-level-container {
        width: 80vw;
        margin: 0 auto;
        margin-top: 80px;
    }
</style>
</head>
<body>
    <header>
        <h1>Pet Monitor</h1>
    </header>
    <main>
        <div class="main-content">
            <div class="main-cam-container">
                <img src="stream.mjpg" class="main-cam"/>
            </div>
            <div class="poop-capture-container">
                <div class="shadow-poop-capture-container">
                    <p class="label">Shadow's Pad</p>
                    <img src="" class="shadow-poop-capture"/>
                    <input type="range" min="1" max="100" value="50" class="slider" id="shadow-slider">
                    <p class="detected">POOP DETECTED, CHANGE THE PAD</p>
                </div>
                <div class="habichuela-poop-capture-container">
                    <p class="label">Habichuela's litter box</p>
                    <img src="" class="habichuela-poop-capture"/>
                    <input type="range" min="1" max="100" value="50" class="slider" id="habichuela-slider">
                    <p class="detected">POOP DETECTED, POUR SOME BAKING SODA</p>
                </div>
            </div>
        </div>
        <div class="water-food-level-container">
            <p class="water-level-message">
                Water level normal
            </p>
            <p class="food-level-message">
                Food level normal
            </p>
        </div>
    </main>
</body>
</html>